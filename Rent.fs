\ Rent.fs
INCLUDE ffl/hnt.fs
INCLUDE ffl/hct.fs

10000 CONSTANT MAX-ORDERS
VARIABLE VALUES 0 VALUES !
VARIABLE MAXIMUM
VARIABLE CURRENT

: UPDATE-VARIABLE ( n adr -- )
    DUP @ ROT MAX SWAP ! ;

: S>KEY ( n -- adr,cnt )
    BASE @ SWAP 64 BASE !
    S>D <# #S #> 
    ROT BASE ! ;

: GET-VALUE ( k -- n,f | false )
    S>KEY VALUES @ HCT-GET ;

: SET-VALUE ( n k -- )
    S>KEY VALUES @ HCT-INSERT ;

: UPDATE-VALUE ( n,k -- )
    TUCK GET-VALUE 
    IF MAX THEN
    SWAP SET-VALUE ;
    
: FREE-VALUES
    VALUES @ ?DUP IF HCT-FREE THEN ;

: NEW-VALUES
    MAX-ORDERS 2* HCT-NEW VALUES ! ;

: INITIALIZE ( -- )
    FREE-VALUES NEW-VALUES
    0 MAXIMUM ! 0 CURRENT ! ;


: ADD-ORDER ( start,duration,bid -- )
    -ROT OVER CURRENT @ OVER UPDATE-VALUE
    GET-VALUE DROP CURRENT UPDATE-VARIABLE
    + SWAP CURRENT @ + 
    DUP ROT UPDATE-VALUE
    MAXIMUM UPDATE-VARIABLE ;


    

