\ Rent.fs

REQUIRE ffl/hct.fs
REQUIRE ffl/act.fs

10000 CONSTANT MAX-ORDERS#
0 CONSTANT CASH%
1 CONSTANT RENT%
VARIABLE HCT-PLAN
VARIABLE RENT-VALUE

: INITIALIZE
    RENT-VALUE OFF
    HCT-PLAN @ ?DUP IF HCT-(FREE) THEN
    MAX-ORDERS# HCT-NEW HCT-PLAN ! ;

: TIME>STRING ( n -- addr c )
    S>D <# #S #> ;

: PLAN@ ( time -- n )
    TIME>STRING HCT-PLAN @ HCT-GET 0= IF 0 THEN ;

: PLAN! ( n time -- )
    TIME>STRING HCT-PLAN @ HCT-INSERT ;

: RENT ( time bid -- )
    RENT-VALUE @ +
    OVER PLAN@ MAX
    SWAP PLAN! ;

: CASH ( time )
    PLAN@ RENT-VALUE @ MAX RENT-VALUE ! ;

: DO-ACTION ( time bid type -- )
    ?DUP IF RENT ELSE CASH THEN ;

: ACTION>KEY ( start end bid -- k )
    ROT 21 LSHIFT ROT OR 21 LSHIFT SWAP OR ;

1 21 LSHIFT 1- CONSTANT 21MASK

: KEY>ACTION ( k -- start end bid )
    DUP 21MASK AND SWAP 21 RSHIFT 
    DUP 21MASK AND SWAP 21 RSHIFT SWAP ROT ;


